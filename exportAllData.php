<?php
require 'config\config.php';
require 'config\functions.php';

$query = mysqli_query($conn,"SELECT form.id, firstsection.accountType, firstsection.minor, firstsection.meroShareService, firstsection.maritalStatus, beneficialowner.title, beneficialowner.firstName, beneficialowner.middleName, beneficialowner.lastName, beneficialowner.fathersName, beneficialowner.grandFathersName, beneficialowner.mothersName, correspondenceaddress.correspondence_province, correspondenceaddress.correspondence_zone, correspondenceaddress.correspondence_district, correspondenceaddress.correspondence_vdc, correspondenceaddress.correspondence_tole, correspondenceaddress.correspondence_ward, correspondenceaddress.correspondence_blockno, correspondenceaddress.correspondence_phoneno, correspondenceaddress.correspondence_mobileno, correspondenceaddress.correspondence_email, permanentaddress.permanent_province, permanentaddress.permanent_zone, permanentaddress.permanent_district, permanentaddress.permanent_vdc, permanentaddress.permanent_tole, permanentaddress.permanent_ward, permanentaddress.permanent_blockno, permanentAddress.permanent_phoneno, permanentAddress.permanent_mobileno, permanentAddress.permanent_email, certificatedetails.citizenshipNo, certificatedetails.citizenshipIssueDistrict, certificatedetails.citizenshipIssueDateBS, certificatedetails.citizenshipIssueDateAD, certificatedetails.DOBBS, certificatedetails.DOBAD, certificatedetails.gender, certificatedetails.panno, bankdetails.bankAccountType, bankdetails.bank, bankdetails.branch, bankdetails.bankAccountno, occupationdetails.occupationType, occupationdetails.businessType, occupationdetails.organizationName, occupationdetails.organizationAddress, occupationdetails.designation, occupationdetails.income, nomineedetails.nominee, nomineedetails.nomineeName, nomineedetails.nomineeFathersName, nomineedetails.nomineeRelationship, nomineedetails.referenceDocument, nomineedetails.nomineeDoc, nomineedetails.placeOfIssue, nomineedetails.nomineeIssueYear, nomineedetails.nomineeAge, nomineedetails.nominee_zone, nomineedetails.nominee_district, nomineedetails.nominee_phoneno, nomineedetails.nominee_mobileno, nomineedetails.nominee_email, nomineedetails.nominee_panno, nomineedetails.nominee_correspondenceAddress, nomineedetails.nomineePhoto, nomineedetails.nomineeSignature, nomineedetails.nomineeDocumentFront, nomineedetails.nomineeDocumentBack, otherdocuments.applicantPhoto, otherdocuments.applicantCitizenshipFrontPhoto, otherdocuments.applicantCitizenshipBackPhoto, otherdocuments.applicantThumbPhoto, otherdocuments.applicantLocationMapPhoto, otherdocuments.applicantSignaturePhoto, guardiandetails.guardianFirstName, guardiandetails.guardianMiddleName, guardiandetails.guardianLastName, guardiandetails.guardianRelation, guardiandetails.guardianFatherName, guardiandetails.guardianGrandFatherName, guardiandetails.guardianSpouseName, guardiandetails.guardianCitizenshipNo, guardiandetails.guardianAddress, guardiandetails.guardian_province, guardiandetails.guardian_zone, guardiandetails.guardian_district, guardiandetails.guardian_vdc, guardiandetails.guardian_blockNo, guardiandetails.guardian_ward, guardiandetails.guardian_phoneno, guardiandetails.guardian_mobileno, guardiandetails.guardian_panno, guardiandetails.guardian_email, guardiandetails.guardian_citizenshipIssueDistrict, guardiandetails.guardian_citizenshipIssueDateBS, guardiandetails.guardian_citizenshipIssueDateAD, guardiandetails.guardian_DOBBS, guardiandetails.guardian_DOBAD, guardiandetails.guardianPhoto, guardiandetails.guardianSignature, guardiandetails.guardianCitizenshipFront, guardiandetails.guardianCitizenshipBack, guardiandetails.guardianProof FROM (((((((((form INNER JOIN firstsection ON form.id = firstsection.firstsection_id) INNER JOIN beneficialowner on form.id = beneficialowner.beneficialowner_id) INNER JOIN correspondenceaddress on form.id = correspondenceaddress.id) INNER JOIN permanentAddress on form.id = permanentaddress.id) INNER JOIN certificatedetails on form.id = certificatedetails.id) INNER JOIN bankdetails on form.id = bankdetails.id) INNER JOIN occupationdetails on form.id = occupationdetails.id) INNER JOIN nomineedetails on form.id = nomineedetails.id) INNER JOIN otherdocuments on form.id = otherdocuments.id) INNER JOIN guardiandetails on form.id = guardiandetails.id;") or die( mysqli_error($conn));

if($query->num_rows > 0){
    $delimiter = ",";
    $filename = "accountOpen_Data_".date('y-m-d').".csv";

    $f = fopen('php://memory', 'w');

    $fields = array('REFERENCE NUMBER', 'ACCOUNT TYPE', 'MINOR', 'MEROSHARE SERVICE', 'MARITAL STATUS', 'TITLE', 'FIRST NAME', 'MIDDLE NAME', 'LAST NAME', 'FATHER NAME', 'GRANDFATHER NAME', 'MOTHER NAME', 'CORRESPONDENCE PROVINCE', 'CORRESPONDENCE ZONE', 'CORRESPONDENCE DISTRICT', 'CORRESPONDENCE VDC', 'CORRESPONDENCE TOLE', 'CORRESPONDENCE WARD', 'CORRESPONDENCE BLOCK NO', 'CORRESPONDENCE PHONE NO', 'CORRESPONDENCE MOBILE NO', 'CORRESPONDENCE EMAIL', 'PERMANENT PROVINCE', 'PERMANENT ZONE', 'PERMANENT DISTRICT', 'PERMANENT VDC', 'PERMANENT TOLE', 'PERMANENT WARD', 'PERMANENT BLOCK NO', 'PERMANENT PHONE NO', 'PERMANENT MOBILE NO', 'PERMANENT EMAIL', 'CITIZENSHIP NO', 'CITIZENSHIP ISSUE DISTRICT', 'CITIZENSHIP ISSUE DATE BS', 'CITIZENSHIP ISSUE DATE AD', 'DOB IN BS', 'DOB IN AD', 'GENDER', 'PAN NO', 'BANK ACCOUNT TYPE', 'BANK', 'BRANCH', 'ACCOUNT NO', 'OCCUPATION TYPE', 'BUSINESS TYPE', 'ORGANIZATION NAME', 'ORGANIZATION ADDRESS', 'DESIGNATION', 'INCOME', 'NOMINEE', 'NOMINEE NAME', 'NOMINEE FATHER NAME', 'NOMINEE RELATIONSHIP', 'REFERENCE DOCUMENT', 'NOMINEE DOC', 'PLACE OF ISSUE', 'NOMINEE ISSUE YEAR', 'NOMINEE AGE', 'NOMINEE ZONE', 'NOMINEE DISTRICT', 'NOMINE PHONE NO', 'NOMINEE MOBILE NO', 'NOMINEE EMAIL', 'NOMINEE PAN NO', 'NOMINEE CORRESPONDENCE ADDRESS', 'NOMINEE PHOTO', 'NOMINEE SIGNATURE', 'NOMINEE DOCUMENT FRONT', 'NOMINEE DOCUMENT BACK', 'APPLICANT PHOTO', 'APPLICANT CITIZENSHIP FRONT PHOTO', 'APPLICANT CITIZENSHIP BACK PHOTO', 'APPLICANT THUMB PHOTO', 'APPLICANT LOCATION MAP PHOTO', 'APPLICANT SIGNATURE PHOTO', 'GUARDIAN FIRST NAME', 'GUARDIAN MIDDLE NAME', 'GUARDIAN LAST NAME', 'GUARDIAN REALTION', 'GUARDIAN FATHER NAME', 'GUARDIAN GRAND FATHER NAME', 'GUARDIAN SPOUSE NAME', 'GUARDIAN CITIZENSHIP NO', 'GUARDIAN ADDRESS', 'GUARDIAN PROVINCE', 'GUARDIAN ZONE', 'GUARDIAN DISTRICT', 'GUARDIAN VDC', 'GUARDIAN BLOCK NO', 'GUARDIAN WARD', 'GUARDIAN PHONE NO', 'GUARDIAN MOBLIE NO', 'GUARDIAN PAN NO', 'GUARDIAN EMAIL', 'GUARDIAN CITIZENSHIP ISSUE DISTRICT', 'GUARDIAN CITIZENSHIP ISSUE DATE BS', 'GUARDIAN CITIZENSHIP ISSUE DATE AD', 'GUARDIAN DOBBS', 'GUARDIAN DOBAD', 'GUARDIAN PHOTO', 'GUARDIAN SIGNATURE', 'GUARDIAN CITIZENSHIP FRONT', 'GUARDIAN CITIZENSHIP BACK' , 'GUARDIAN PROOF');
    fputcsv($f, $fields, $delimiter);

    while($row = $query -> fetch_assoc()){
        $lineData = array($row['id'], $row['accountType'], $row['minor'], $row['meroShareService'], $row['maritalStatus'], $row['title'], $row['firstName'], $row['middleName'], $row['lastName'], $row['fathersName'], $row['grandFathersName'], $row['mothersName'], $row['correspondence_province'], $row['correspondence_zone'], $row['correspondence_district'], $row['correspondence_vdc'], $row['correspondence_tole'], $row['correspondence_ward'], $row['correspondence_blockno'], $row['correspondence_phoneno'], $row['correspondence_mobileno'], $row['correspondence_email'] , $row['permanent_province'], $row['permanent_zone'], $row['permanent_district'], $row['permanent_vdc'], $row['permanent_tole'], $row['permanent_ward'], $row['permanent_blockno'], $row['permanent_phoneno'], $row['permanent_mobileno'], $row['permanent_email'], $row['citizenshipNo'], $row['citizenshipIssueDistrict'], $row['citizenshipIssueDateBS'], $row['citizenshipIssueDateAD'], $row['DOBBS'], $row['DOBAD'], $row['gender'], $row['panno'], $row['bankAccountType'], $row['bank'], $row['branch'], $row['bankAccountno'], $row['occupationType'], $row['businessType'], $row['organizationName'], $row['organizationAddress'], $row['designation'], $row['income'], $row['nominee'], $row['nomineeName'], $row['nomineeFathersName'], $row['nomineeRelationship'], $row['referenceDocument'], $row['nomineeDoc'], $row['placeOfIssue'], $row['nomineeIssueYear'], $row['nomineeAge'], $row['nominee_zone'], $row['nominee_district'], $row['nominee_phoneno'], $row['nominee_mobileno'], $row['nominee_email'], $row['nominee_panno'], $row['nominee_correspondenceAddress'], $row['nomineePhoto'], $row['nomineeSignature'], $row['nomineeDocumentFront'], $row['nomineeDocumentBack'], $row['applicantPhoto'], $row['applicantCitizenshipFrontPhoto'], $row['applicantCitizenshipBackPhoto'], $row['applicantThumbPhoto'], $row['applicantLocationMapPhoto'], $row['applicantSignaturePhoto'], $row['guardianFirstName'], $row['guardianMiddleName'], $row['guardianLastName'], $row['guardianRelation'], $row['guardianFatherName'], $row['guardianGrandFatherName'], $row['guardianSpouseName'], $row['guardianCitizenshipNo'], $row['guardianAddress'], $row['guardian_province'], $row['guardian_zone'], $row['guardian_district'], $row['guardian_vdc'], $row['guardian_blockNo'], $row['guardian_ward'], $row['guardian_phoneno'], $row['guardian_mobileno'], $row['guardian_panno'], $row['guardian_email'], $row['guardian_citizenshipIssueDistrict'], $row['guardian_citizenshipIssueDateBS'], $row['guardian_citizenshipIssueDateAD'], $row['guardian_DOBBS'], $row['guardian_DOBAD'], $row['guardianPhoto'], $row['guardianSignature'], $row['guardianCitizenshipFront'], $row['guardianCitizenshipBack'], $row['guardianProof']);
        fputcsv($f, $lineData, $delimiter);
    }

    fseek($f, 0);

    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="'.$filename.'";');

    fpassthru($f);
}
exit;
?>